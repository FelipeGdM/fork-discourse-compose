#!/bin/bash -eux

PG_PASSWORD=`< /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c${1:-32};echo;`

echo "DISCOURSE_SMTP_ADDRESS=${MAIL_HOST}" > .env
echo "DISCOURSE_SMTP_USER_NAME=${MAIL_USER}" >> .env
echo "DISCOURSE_SMTP_PASSWORD=${MAIL_PASS}" >> .env
echo "POSTGRES_PASSWORD=${PG_PASSWORD}" >> .env
echo "DISCOURSE_DB_PASSWORD=${PG_PASSWORD}" >> .env

VIRTUAL_HOST=${URL} docker-compose run app bash -c "sleep 3 && rake db:migrate assets:precompile"
